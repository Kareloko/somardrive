<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SomarDrive V20 GPS üß†üöö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d1b3d">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --card-bg: #1e293b;
      --accent: #3b82f6;
      --text: #f1f5f9;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --blue: #3b82f6;
    }

    body {
      margin: 0;
      background: var(--bg-dark);
      font-family: 'Montserrat', sans-serif;
      color: var(--text);
      padding-bottom: 140px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }

    /* HEADER */
    .app-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .app-header-icon {
      font-size: 33px;
      background: #1e3a8a;
      width: 45px;
      height: 45px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .app-header-title {
      font-size: 1.4rem;
      font-weight: 800;
    }

    /* DIOS */
    .god-banner {
      background: linear-gradient(135deg, #1e3a8a, #172554);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
    }

    .god-title {
      font-weight: 900;
      color: #fbbf24;
      margin-bottom: 5px;
    }

    .god-text {
      font-style: italic;
      color: #e2e8f0;
    }

    /* BOTONES PRINCIPALES */
    .btn-main {
      padding: 13px;
      border-radius: 12px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }

    .btn-blue { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); color:white; }
    .btn-gray { background: #334155; color:#e5e7eb; }
    .btn-red { background: #dc2626; color:white; }
    .btn-green { background: #16a34a; color:white; }

    /* PREVIEW FOTO */
    #previewContainer {
      display:none;
      margin-top:15px;
      border:2px solid #334155;
      border-radius:10px;
      overflow:hidden;
    }

    #preview { width:100%; display:block; }

    #clearPhotoBtn {
      margin-top:10px;
      background:#ef4444;
      border-radius:10px;
      padding:10px;
      font-weight:700;
      border:none;
      width:100%;
      color:white;
    }

    #ocrStatus {
      display:none;
      text-align:center;
      font-weight:700;
      color:var(--blue);
      margin:10px 0;
    }

    /* EDITOR */
    #editorSection {
      display:none;
      background:var(--card-bg);
      padding:15px;
      border-radius:15px;
      margin-top:20px;
    }

    #linesContainer {
      max-height:150px;
      overflow-y:auto;
      background:#0f172a;
      border-radius:8px;
      padding:6px;
      border:1px solid rgba(255,255,255,0.1);
    }

    .line-item {
      display:flex;
      gap:10px;
      padding:7px;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }

    #finalText {
      width:100%;
      margin-top:10px;
      background:#020617;
      color:white;
      border:2px solid #334155;
      border-radius:10px;
      padding:10px;
      min-height:70px;
    }

    /* RUTA */
    #addressList { padding:0; list-style:none; margin-top:15px; }

    .card {
      background:var(--card-bg);
      padding:15px;
      border-radius:12px;
      border-left:5px solid var(--yellow);
      margin-bottom:12px;
      position:relative;
      overflow:hidden;
      transition: transform .25s, opacity .25s;
    }

    .card-dist {
      color:#38bdf8;
      font-size:0.8rem;
      margin-bottom:6px;
    }

    /* SWIPE COLORS */
    .swipe-bg-left, .swipe-bg-right {
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:flex; align-items:center; font-size:1.4rem;
      opacity:0; transition:opacity .2s;
    }
    .swipe-bg-left { justify-content:flex-start; padding-left:20px; color:white; background:#dc2626; }
    .swipe-bg-right { justify-content:flex-end; padding-right:20px; color:white; background:#16a34a; }

    .memory-btn {
      background:var(--yellow);
      padding:8px 14px;
      border-radius:999px;
      border:none;
      font-weight:900;
      cursor:pointer;
      color:#111;
    }

    /* BOTONES FINALES (2x2) */
    .backup-buttons-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:15px;
    }

    .btn-slim {
      padding:10px;
      font-size:0.9rem;
      border-radius:10px;
      border:none;
      font-weight:700;
      text-shadow:0 1px 2px rgba(0,0,0,0.3);
      white-space:nowrap;
    }

    .logo-box {
      margin-top:18px;
      display:flex;
      justify-content:center;
    }
    .logo-box img {
      width:80%;
      max-width:260px;
      border-radius:12px;
    }

    .footer-static {
      position:fixed;
      bottom:0;
      width:100%;
      background:#020617;
      padding:8px;
      text-align:center;
      font-weight:800;
      color:#ef4444;
      font-size:0.9rem;
      box-shadow:0 -2px 8px rgba(0,0,0,0.5);
    }
  </style>
</head>

<body>

<div class="container">

  <div class="app-header">
    <div class="app-header-icon">üöö</div>
    <div class="app-header-title">SOMAR DRIVE</div>
  </div>

  <div class="god-banner">
    <div class="god-title">üëë EL PRIMER LUGAR ES DE DIOS</div>
    <div class="god-text">"Encomienda a Jehov√° tu camino, y conf√≠a en √©l; y √©l har√°."</div>
  </div>

  <!-- FOTO -->
  <h2>üì∏ 1. Capturar direcci√≥n</h2>

  <div style="display:flex; gap:10px;">
    <button class="btn-main btn-blue" onclick="cameraInput.click()">üì∑ C√°mara</button>
    <button class="btn-main btn-gray" onclick="fileInput.click()">üìÇ Galer√≠a</button>
  </div>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="processImage(this)">
  <input type="file" id="fileInput" accept="image/*" hidden onchange="processImage(this)">

  <div id="previewContainer">
    <img id="preview">
    <button id="clearPhotoBtn" onclick="clearImage()">‚ùå Borrar foto</button>
  </div>

  <div id="ocrStatus">‚è≥ Leyendo texto (IT)...</div>

  <!-- EDITOR -->
  <div id="editorSection">
    <h3>üìù 2. Selecciona l√≠neas</h3>
    <div id="linesContainer"></div>
    <textarea id="finalText"></textarea>
    <button class="btn-main btn-green" onclick="saveAddress()">üíæ Guardar en Ruta</button>
  </div>

  <!-- RUTA + MEMORIA -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <h2>üìç Ruta <span id="countPending">0</span></h2>
    <button class="memory-btn" onclick="openMemory()">üß† Memoria <span id="memCount">0</span></button>
  </div>

  <div style="display:flex; gap:10px;">
    <button class="btn-main btn-gray" onclick="sortWithGPS()">üîÑ Ordenar por GPS</button>
    <button class="btn-main btn-gray" onclick="saveAllToMemory()">üõ°Ô∏è Guardar ruta en memoria</button>
  </div>

  <ul id="addressList"></ul>

  <h2 style="margin-top:25px;">üõ°Ô∏è Copias y limpieza</h2>

  <div class="backup-buttons-grid">
    <button class="btn-slim btn-green" onclick="exportData()">‚¨áÔ∏è Descargar</button>
    <button class="btn-slim btn-gray" onclick="importInput.click()">‚¨ÜÔ∏è Cargar</button>
    <button class="btn-slim btn-red" onclick="clearRoute()">üóë Ruta</button>
    <button class="btn-slim btn-red" onclick="clearMemory()">üí£ Memoria</button>
  </div>

  <input type="file" id="importInput" accept=".json" hidden onchange="importData(this)">

  <div class="logo-box">
    <img src="somardrive_logo.png">
  </div>

</div>

<div class="footer-static">‚ö†Ô∏è CONDUCE CON CUIDADO ¬∑ EN CASA TE ESPERAN</div>

<script>
/* ===========================
   CONFIGURACI√ìN GENERAL
=========================== */

const DB_KEY   = "SomarDrive_Route_V20";
const HIST_KEY = "SomarDrive_Memory_V20";

// PON AQU√ç TU API KEY REAL
const ORS_API_KEY = "PON_AQUI_TU_API_KEY_DE_ORS";

let addresses = [];
let historyDB = [];

window.addEventListener("load", () => {
  addresses = JSON.parse(localStorage.getItem(DB_KEY)) || [];
  historyDB = JSON.parse(localStorage.getItem(HIST_KEY)) || [];

  renderList();
  updateMemoryCount();
});

/* ===========================
   FUNCIONES B√ÅSICAS
=========================== */

function saveData() {
  localStorage.setItem(DB_KEY, JSON.stringify(addresses));
  renderList();
}

function saveMem() {
  localStorage.setItem(HIST_KEY, JSON.stringify(historyDB));
  updateMemoryCount();
}

function updateMemoryCount() {
  document.getElementById("memCount").textContent = historyDB.length;
}

/* ===========================
   FOTO / OCR
=========================== */

function processImage(input){
  if(!input.files[0]) return;
  preview.src = URL.createObjectURL(input.files[0]);
  previewContainer.style.display = "block";
  ocrStatus.style.display = "block";
  editorSection.style.display = "none";

  Tesseract.recognize(input.files[0], 'ita')
  .then(({data:{text}})=>{
    ocrStatus.style.display="none";
    showEditor(text);
  })
}

function clearImage(){
  previewContainer.style.display="none";
  cameraInput.value="";
  fileInput.value="";
}

/* ===========================
   EDITOR
=========================== */

function showEditor(text){
  editorSection.style.display="block";
  let lines = text.split("\n").map(a=>a.trim()).filter(a=>a.length>2);

  linesContainer.innerHTML="";
  finalText.value="";

  lines.forEach(l=>{
    let div=document.createElement("div");
    div.className="line-item";
    div.innerHTML=`<input type="checkbox" value="${l}" onchange="updateFinal()"><span>${l}</span>`;
    linesContainer.appendChild(div);
  });
}

function updateFinal(){
  let checks=[...linesContainer.querySelectorAll("input[type='checkbox']:checked")];
  finalText.value = checks.map(c=>c.value).join(", ");
}

/* ===========================
   RUTA + GUARDAR DIRECCI√ìN
=========================== */

function saveAddress(){
  let text = finalText.value.trim();
  if(!text){ alert("Texto vac√≠o"); return; }

  // NO duplicados en memoria
  if(historyDB.some(h=>h.text.toLowerCase()==text.toLowerCase())){
    alert("‚ùå Esta direcci√≥n ya existe en la memoria.");
    return;
  }

  addresses.unshift({text, lat:null, lon:null, dist:null});
  saveData();

  historyDB.push({text});
  saveMem();

  alert("üíæ Guardado en ruta y memoria.");

  editorSection.style.display="none";
  previewContainer.style.display="none";
}

/* ===========================
   RENDER RUTA
=========================== */

function renderList(){
  let ul=document.getElementById("addressList");
  ul.innerHTML="";

  document.getElementById("countPending").textContent = addresses.length;

  addresses.forEach((item,index)=>{
    let li=document.createElement("li");
    li.className="card";
    li.innerHTML=`
      <div class="swipe-bg-left">üóë</div>
      <div class="swipe-bg-right">‚úî</div>
      <div class="card-text">${item.text}</div>
      ${item.dist!=null? `<div class="card-dist">üèÅ ${item.dist.toFixed(1)} km</div>` : ""}
      <div class="card-actions">
        <button class="btn-main btn-blue" onclick="openMap(${index})">üó∫ Navegar</button>
        <button class="btn-main btn-red" onclick="deleteItem(${index})">üóë</button>
      </div>
    `;

    setupSwipe(li,index);

    ul.appendChild(li);
  });
}

function openMap(i){
  let a=addresses[i];
  if(a.lat && a.lon)
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${a.lat},${a.lon}`);
  else
    window.open(`https://www.google.com/maps/search/?q=${encodeURIComponent(a.text)}`);
}

function deleteItem(i){
  addresses.splice(i,1);
  saveData();
}

function markDelivered(i){
  addresses.splice(i,1);
  saveData();
}

/* ===========================
   SWIPE PROFESIONAL SOMARDRIVE
=========================== */

function setupSwipe(card,index){
  let startX=0, currentX=0, dragging=false;

  const leftBg = card.querySelector(".swipe-bg-left");
  const rightBg = card.querySelector(".swipe-bg-right");

  card.addEventListener("touchstart",e=>{
    startX = e.touches[0].clientX;
    dragging = true;
  });

  card.addEventListener("touchmove",e=>{
    if(!dragging) return;
    currentX = e.touches[0].clientX - startX;

    card.style.transform = `translateX(${currentX}px)`;

    if(currentX > 40){
      rightBg.style.opacity=1;
    } else rightBg.style.opacity=0;

    if(currentX < -40){
      leftBg.style.opacity=1;
    } else leftBg.style.opacity=0;
  });

  card.addEventListener("touchend",()=>{
    dragging=false;

    if(currentX > 100){
      navigator.vibrate?.(30);
      animateRemoval(card,()=>markDelivered(index));
    }
    else if(currentX < -100){
      navigator.vibrate?.(30);
      animateRemoval(card,()=>deleteItem(index));
    }
    else {
      card.style.transform="translateX(0)";
      leftBg.style.opacity=0;
      rightBg.style.opacity=0;
    }
    currentX=0;
  });
}

function animateRemoval(card,callback){
  card.style.opacity="0";
  card.style.transform="scale(0.85)";
  setTimeout(callback,250);
}

/* ===========================
   MEMORIA
=========================== */

function openMemory(){
  if(!historyDB.length){ alert("Memoria vac√≠a"); return; }

  let list = historyDB.map((h,i)=>`${i+1}. ${h.text}`).join("\n");
  let pick = prompt("üß† MEMORIA:\n\n"+list+"\n\nN√∫mero:");

  if(!pick) return;
  let idx = parseInt(pick)-1;
  if(idx<0 || idx>=historyDB.length) return;

  finalText.value = historyDB[idx].text;
  editorSection.style.display="block";
}

function saveAllToMemory(){
  let added=0;

  addresses.forEach(a=>{
    if(!historyDB.some(h=>h.text.toLowerCase()==a.text.toLowerCase())){
      historyDB.push({text:a.text});
      added++;
    }
  });

  saveMem();
  alert("üß† Se a√±adieron "+added+" nuevas direcciones a la memoria.");
}

/* ===========================
   BACKUP
=========================== */

function exportData(){
  let data = JSON.stringify(addresses);
  let a=document.createElement("a");
  a.href="data:application/json,"+encodeURIComponent(data);
  a.download="somardrive_ruta.json";
  a.click();
}

function importData(input){
  let file=input.files[0];
  if(!file) return;

  let reader=new FileReader();
  reader.onload=e=>{
    addresses = JSON.parse(e.target.result);
    saveData();
  }
  reader.readAsText(file);
}

function clearRoute(){
  if(confirm("¬øBorrar toda la ruta?")){
    addresses=[];
    saveData();
  }
}

function clearMemory(){
  if(confirm("¬øBorrar memoria completa?")){
    historyDB=[];
    saveMem();
  }
}

/* ===========================
   GPS REAL
=========================== */

function haversine(lat1,lon1,lat2,lon2){
  const R=6371;
  const toRad=d=>(d*Math.PI)/180;
  let dLat=toRad(lat2-lat1);
  let dLon=toRad(lon2-lon1);
  let a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function sortWithGPS(){
  if(!addresses.length){ alert("No hay direcciones"); return; }
  if(!navigator.geolocation){ alert("GPS no disponible"); return; }
  if(!ORS_API_KEY || ORS_API_KEY==="PON_AQUI_TU_API_KEY_DE_ORS"){
    alert("Falta clave ORS");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    let myLat=pos.coords.latitude;
    let myLon=pos.coords.longitude;

    for(const a of addresses){
      if(!a.lat || !a.lon){
        try{
          let clean = a.text.replace(/cliente|entregar|tel|cell/gi,"").trim();
          let url = `https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(clean)}&size=1`;
          let res = await fetch(url);
          let data = await res.json();

          if(data.features?.length){
            let c=data.features[0].geometry.coordinates;
            a.lon=c[0];
            a.lat=c[1];
          }
          await new Promise(r=>setTimeout(r,2000));
        }catch(e){}
      }

      if(a.lat && a.lon){
        a.dist = haversine(myLat,myLon,a.lat,a.lon);
      }
    }

    addresses.sort((x,y)=>{
      if(x.dist==null) return 1;
      if(y.dist==null) return -1;
      return x.dist - y.dist;
    });

    saveData();

  }, err=>alert("No se pudo obtener ubicaci√≥n"));
}

</script>
</body>
</html>
