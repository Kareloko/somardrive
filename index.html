<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SomarDrive V21 üööüß†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d1b3d">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --card-bg: #1e293b;
      --accent: #3b82f6;
      --text: #f1f5f9;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --blue: #38bdf8;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Montserrat', sans-serif;
      padding-bottom: 140px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }

    /* HEADER APP */
    .app-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .app-header-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: #1e3a8a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    .app-header-title {
      font-weight: 800;
      font-size: 1.4rem;
    }

    /* BANNER DIOS */
    .god-banner {
      background: linear-gradient(135deg, #1e3a8a, #172554);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .god-title {
      font-weight: 900;
      color: #fbbf24;
      margin-bottom: 6px;
      font-size: 1rem;
    }
    .god-text {
      font-size: 0.9rem;
      font-style: italic;
      color: #e2e8f0;
    }

    /* BOTONES MAIN */
    .btn-main {
      padding: 13px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
      white-space: nowrap;
    }
    .btn-main:active { transform: scale(0.97); }

    .btn-blue  { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); color:#fff; }
    .btn-gray  { background: #334155; color:#e5e7eb; }
    .btn-red   { background: #dc2626; color:#fff; }
    .btn-green { background: #16a34a; color:#fff; }

    /* PREVIEW FOTO */
    #previewContainer {
      display: none;
      margin-top: 10px;
      border-radius: 10px;
      border: 2px solid #334155;
      overflow: hidden;
    }
    #preview { width: 100%; display: block; }

    #clearPhotoBtn {
      width: 100%;
      margin-top: 6px;
      border: none;
      border-radius: 10px;
      background: #ef4444;
      color: #fff;
      font-weight: 700;
      padding: 8px;
      cursor: pointer;
    }

    #ocrStatus {
      display:none;
      margin: 10px 0;
      text-align:center;
      font-weight:700;
      color: var(--accent);
    }

    /* EDITOR */
    #editorSection {
      display:none;
      margin-top: 15px;
      padding: 15px;
      border-radius: 15px;
      background: var(--card-bg);
    }
    #linesContainer {
      max-height: 150px;
      overflow-y:auto;
      background:#020617;
      border-radius:8px;
      padding:6px;
      border:1px solid rgba(148,163,184,0.5);
    }
    .line-item {
      display:flex;
      gap:8px;
      padding:6px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      font-size:0.9rem;
    }
    .line-item:last-child { border-bottom:none; }

    #finalText {
      width:100%;
      margin-top:8px;
      padding:10px;
      border-radius:10px;
      border:2px solid #334155;
      background:#020617;
      color:#fff;
      min-height:70px;
      font-family:inherit;
      font-size:0.9rem;
      resize:vertical;
    }

    /* RUTA */
    #addressList {
      list-style:none;
      padding:0;
      margin-top:15px;
    }

    .card {
      position:relative;
      background: var(--card-bg);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 5px solid var(--yellow);
      transition: border-color .25s;
    }
    .card-near { border-left-color: #38bdf8; }
    .card-arrived { border-left-color: #22c55e; }

    .card-text {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .card-dist {
      font-size: 0.8rem;
      color: var(--blue);
      margin-bottom: 6px;
    }

    .card-actions {
      display:flex;
      gap:8px;
      margin-top:4px;
    }
    .btn-icon {
      width:54px;
      height:40px;
      border-radius:12px;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.4rem;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(0,0,0,0.35);
    }
    .btn-icon-map   { background:linear-gradient(to bottom,#38bdf8,#1d4ed8); color:#fff; }
    .btn-icon-trash { background:linear-gradient(to bottom,#f97316,#dc2626); color:#fff; }

    /* MEMORIA HEADER */
    .memory-btn {
      background: var(--yellow);
      color:#111827;
      border-radius:999px;
      border:none;
      padding:6px 12px;
      font-weight:800;
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    /* BOTONES FINALES */
    .backup-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:15px;
    }
    .btn-slim {
      border:none;
      border-radius:10px;
      padding:9px;
      font-size:0.9rem;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
      text-shadow:0 1px 2px rgba(0,0,0,0.35);
    }

    .logo-box {
      margin-top:16px;
      display:flex;
      justify-content:center;
    }
    .logo-box img {
      width:80%;
      max-width:260px;
      border-radius:12px;
    }

    /* FOOTER */
    .footer-static {
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      background:#020617;
      text-align:center;
      padding:8px;
      font-weight:800;
      color:#ef4444;
      font-size:0.9rem;
      box-shadow:0 -2px 8px rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>

<div class="container">

  <!-- HEADER -->
  <div class="app-header">
    <div class="app-header-icon">üöö</div>
    <div class="app-header-title">SOMAR DRIVE</div>
  </div>

  <!-- DIOS -->
  <div class="god-banner">
    <div class="god-title">üëë EL PRIMER LUGAR ES DE DIOS</div>
    <div class="god-text">"Encomienda a Jehov√° tu camino, y conf√≠a en √©l; y √©l har√°." (Salmos 37:5)</div>
  </div>

  <!-- CAPTURA -->
  <h2>üì∏ 1. Capturar direcci√≥n</h2>
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn-main btn-blue" onclick="document.getElementById('cameraInput').click()">üì∑ C√°mara</button>
    <button class="btn-main btn-gray" onclick="document.getElementById('fileInput').click()">üìÇ Galer√≠a</button>
  </div>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="processImage(this)">
  <input type="file" id="fileInput" accept="image/*" hidden onchange="processImage(this)">

  <div id="previewContainer">
    <img id="preview">
  </div>
  <button id="clearPhotoBtn" style="display:none;" onclick="clearImage()">‚ùå Borrar foto</button>

  <div id="ocrStatus">‚è≥ Leyendo texto (IT)...</div>

  <!-- EDITOR -->
  <div id="editorSection">
    <h3>üìù 2. Selecciona y arma la direcci√≥n</h3>
    <div id="linesContainer"></div>
    <textarea id="finalText" placeholder="Aqu√≠ aparecer√° la direcci√≥n combinada..."></textarea>
    <button class="btn-main btn-green" style="margin-top:8px;" onclick="saveAddress()">üíæ Guardar en Ruta</button>
  </div>

  <!-- RUTA + MEMORIA -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
    <h2 style="margin:0;">üìç Ruta <span id="routeCount">0</span></h2>
    <button class="memory-btn" onclick="openMemory()">üß† Memoria <span id="memCount">0</span></button>
  </div>

  <!-- CONTROLES GPS -->
  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">
    <button id="gpsBtn" class="btn-main btn-gray" onclick="sortWithGPS()">üîÑ Ordenar por GPS</button>
    <button id="liveBtn" class="btn-main btn-gray" onclick="toggleLiveTracking()">üõ∞ Rastreo vivo: OFF</button>
  </div>

  <button id="saveRouteBtn" class="btn-main btn-gray" style="margin-top:8px;" onclick="saveAllToMemory()">üõ°Ô∏è Guardar ruta en memoria</button>

  <button id="autoSortBtn" class="btn-main btn-gray" style="margin-top:6px; font-size:0.8rem; padding:8px 10px;" onclick="toggleAutoSort()">‚öôÔ∏è Auto-organizar: OFF</button>

  <ul id="addressList"></ul>

  <!-- COPIAS Y LIMPIEZA -->
  <h2 style="margin-top:22px;">üõ°Ô∏è Copias y limpieza</h2>
  <div class="backup-grid">
    <button class="btn-slim btn-green" onclick="exportData()">‚¨áÔ∏è Descargar ruta</button>
    <button class="btn-slim btn-gray" onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Cargar ruta</button>
    <button class="btn-slim btn-red" onclick="clearRoute()">üóë Borrar SOLO ruta</button>
    <button class="btn-slim btn-red" onclick="clearMemory()">üí£ Borrar SOLO memoria</button>
  </div>

  <input type="file" id="importInput" accept=".json" hidden onchange="importData(this)">

  <!-- LOGO -->
  <div class="logo-box">
    <!-- Cambia el src si tu archivo se llama distinto -->
    <img src="somardrive_logo.png" alt="SomarDrive Logo">
  </div>

</div>

<div class="footer-static">‚ö†Ô∏è CONDUCE CON CUIDADO ¬∑ EN CASA TE ESPERAN</div>

<script>
  // ==============================
  // CONFIGURACI√ìN GENERAL
  // ==============================

  const DB_KEY   = "SomarDrive_Route_V21";
  const HIST_KEY = "SomarDrive_Memory_V21";

  // PON AQU√ç TU CLAVE REAL DE OPENROUTESERVICE
  const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImI5NjlmYzJiMDY0YjQzMWQ5NDBmMGE0NjYzOWJiMWI2IiwiaCI6Im11cm11cjY0In0=";

  const LIVE_INTERVAL_MS = 10000; // 10 segundos (referencia)

  let addresses = []; // { text, lat, lon, dist, nearAlerted, arrivedAlerted }
  let historyDB = []; // { text, lat, lon }

  let liveWatchId = null;
  let liveTracking = false;
  let autoSortEnabled = false;

  // ==============================
  // INICIO
  // ==============================

  window.addEventListener("load", () => {
    try {
      const r = localStorage.getItem(DB_KEY);
      if (r) addresses = JSON.parse(r);
    } catch (e) {
      addresses = [];
    }

    try {
      const m = localStorage.getItem(HIST_KEY);
      if (m) historyDB = JSON.parse(m);
    } catch (e) {
      historyDB = [];
    }

    renderList();
    updateMemoryCount();
    updateLiveBtn();
    updateAutoSortBtn();
  });

  function saveData() {
    localStorage.setItem(DB_KEY, JSON.stringify(addresses));
    renderList();
  }

  function saveMem() {
    localStorage.setItem(HIST_KEY, JSON.stringify(historyDB));
    updateMemoryCount();
  }

  function updateMemoryCount() {
    document.getElementById("memCount").textContent = historyDB.length;
  }

  // ==============================
  // FOTO / OCR
  // ==============================

  function processImage(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];

    const preview = document.getElementById("preview");
    const previewContainer = document.getElementById("previewContainer");
    const clearBtn = document.getElementById("clearPhotoBtn");

    preview.src = URL.createObjectURL(file);
    previewContainer.style.display = "block";
    clearBtn.style.display = "block";

    document.getElementById("ocrStatus").style.display = "block";
    document.getElementById("editorSection").style.display = "none";
    document.getElementById("linesContainer").innerHTML = "";
    document.getElementById("finalText").value = "";

    Tesseract.recognize(file, "ita")
      .then(({ data: { text } }) => {
        document.getElementById("ocrStatus").style.display = "none";
        showEditor(text);
      })
      .catch(() => {
        document.getElementById("ocrStatus").style.display = "none";
        alert("‚ùå Error al leer la imagen.");
      });
  }

  function clearImage() {
    document.getElementById("previewContainer").style.display = "none";
    document.getElementById("clearPhotoBtn").style.display = "none";
    document.getElementById("cameraInput").value = "";
    document.getElementById("fileInput").value = "";
    document.getElementById("editorSection").style.display = "none";
  }

  // ==============================
  // EDITOR
  // ==============================

  function showEditor(text) {
    const lines = text
      .split("\n")
      .map(l => l.trim())
      .filter(l => l.length > 3);

    const editor = document.getElementById("editorSection");
    const container = document.getElementById("linesContainer");
    const finalText = document.getElementById("finalText");

    editor.style.display = "block";
    container.innerHTML = "";
    finalText.value = "";

    if (!lines.length) {
      container.innerHTML = "<div style='color:#94a3b8; padding:6px;'>No se detect√≥ texto √∫til. Prueba otra foto.</div>";
      return;
    }

    lines.forEach(line => {
      const div = document.createElement("div");
      div.className = "line-item";
      div.innerHTML = `
        <input type="checkbox" value="${line.replace(/"/g, '&quot;')}" onchange="updateFinalText()">
        <span>${line}</span>
      `;
      container.appendChild(div);
    });
  }

  function updateFinalText() {
    const checks = Array.from(
      document.querySelectorAll("#linesContainer input[type='checkbox']:checked")
    );
    const vals = checks.map(c => c.value);
    document.getElementById("finalText").value = vals.join(", ");
  }

  function saveAddress() {
    const txt = document.getElementById("finalText").value.trim();
    if (!txt) {
      alert("‚ö†Ô∏è Escribe o selecciona la direcci√≥n.");
      return;
    }

    // no duplicar en memoria
    const exists = historyDB.some(h => (h.text || "").toLowerCase() === txt.toLowerCase());
    if (exists) {
      alert("‚ùå Esta direcci√≥n ya existe en la memoria.");
      return;
    }

    addresses.unshift({
      text: txt,
      lat: null,
      lon: null,
      dist: null,
      nearAlerted: false,
      arrivedAlerted: false
    });
    saveData();

    historyDB.push({ text: txt, lat: null, lon: null });
    saveMem();

    alert("üíæ Guardado en ruta y memoria.");
    clearImage();
  }

  // ==============================
  // RENDER RUTA
  // ==============================

  function renderList() {
    const ul = document.getElementById("addressList");
    ul.innerHTML = "";

    document.getElementById("routeCount").textContent = addresses.length;

    if (!addresses.length) {
      ul.innerHTML = "<div style='text-align:center; padding:20px; color:#64748b;'>Sin direcciones.<br>Empieza capturando una foto.</div>";
      return;
    }

    addresses.forEach((item, index) => {
      const li = document.createElement("li");
      let cls = "card";
      if (item.arrivedAlerted) cls += " card-arrived";
      else if (item.nearAlerted) cls += " card-near";
      li.className = cls;

      const distHtml = item.dist != null
        ? `<div class="card-dist">üèÅ ${item.dist < 1 ? (item.dist * 1000).toFixed(0) + " m" : item.dist.toFixed(1) + " km"}</div>`
        : "";

      li.innerHTML = `
        <div class="card-text">${item.text}</div>
        ${distHtml}
        <div class="card-actions">
          <button class="btn-icon btn-icon-map" onclick="openMap(${index})">üó∫Ô∏è</button>
          <button class="btn-icon btn-icon-trash" onclick="deleteItem(${index})">üóëÔ∏è</button>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function openMap(index) {
    const item = addresses[index];
    if (item.lat != null && item.lon != null) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lon}`;
      window.open(url, "_blank");
    } else {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.text)}`;
      window.open(url, "_blank");
    }
  }

  function deleteItem(index) {
    if (!confirm("¬øBorrar esta direcci√≥n de la ruta?")) return;
    addresses.splice(index, 1);
    saveData();
  }

  // ==============================
  // MEMORIA
  // ==============================

  function openMemory() {
    if (!historyDB.length) {
      alert("Memoria vac√≠a.");
      return;
    }

    const listado = historyDB.map((h, i) => `${i + 1}. ${h.text}`).join("\n");
    const resp = prompt("üß† MEMORIA\n\n" + listado + "\n\nEscribe el n√∫mero para traerlo a la ruta:");

    if (!resp) return;
    const idx = parseInt(resp, 10) - 1;
    if (isNaN(idx) || idx < 0 || idx >= historyDB.length) return;

    const mem = historyDB[idx];
    addresses.unshift({
      text: mem.text,
      lat: mem.lat || null,
      lon: mem.lon || null,
      dist: null,
      nearAlerted: false,
      arrivedAlerted: false
    });
    saveData();
  }

  function saveAllToMemory() {
    let added = 0;

    addresses.forEach(item => {
      const exists = historyDB.some(h => (h.text || "").toLowerCase() === item.text.toLowerCase());
      if (!exists) {
        historyDB.push({ text: item.text, lat: item.lat || null, lon: item.lon || null });
        added++;
      }
    });

    saveMem();
    alert("üß† Se a√±adieron " + added + " nuevas direcciones a la memoria.");
  }

  // ==============================
  // BACKUP
  // ==============================

  function exportData() {
    if (!addresses.length) {
      alert("No hay ruta para exportar.");
      return;
    }
    const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(addresses));
    const a = document.createElement("a");
    a.href = dataStr;
    a.download = "somardrive_ruta.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function importData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        if (Array.isArray(imported)) {
          addresses = imported;
          saveData();
          alert("‚úÖ Ruta cargada.");
        } else {
          alert("Formato incorrecto.");
        }
      } catch (err) {
        alert("Error al leer el archivo.");
      }
      input.value = "";
    };
    reader.readAsText(file);
  }

  function clearRoute() {
    if (!addresses.length) {
      alert("No hay ruta.");
      return;
    }
    if (!confirm("¬øBorrar SOLO la ruta? La memoria se mantiene.")) return;
    addresses = [];
    saveData();
  }

  function clearMemory() {
    if (!historyDB.length) {
      alert("No hay memoria.");
      return;
    }
    if (!confirm("‚ö†Ô∏è ¬øBorrar TODA la memoria? La ruta se mantiene.")) return;
    historyDB = [];
    saveMem();
  }

  // ==============================
  // GPS / ORDENAR POR DISTANCIA
  // ==============================

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  async function sortWithGPS() {
    if (!addresses.length) {
      alert("No hay direcciones para ordenar.");
      return;
    }
    if (!navigator.geolocation) {
      alert("Tu dispositivo no permite obtener la ubicaci√≥n.");
      return;
    }
    if (!ORS_API_KEY || ORS_API_KEY === "PON_AQUI_TU_API_KEY_DE_ORS") {
      alert("Configura tu API KEY de OpenRouteService en el c√≥digo.");
      return;
    }

    alert("üõ∞ Calculando ruta por GPS...");

    navigator.geolocation.getCurrentPosition(async pos => {
      const myLat = pos.coords.latitude;
      const myLon = pos.coords.longitude;

      for (const item of addresses) {
        if (item.lat == null || item.lon == null) {
          try {
            const clean = (item.text || "").replace(/cliente|entregar|tel|cell|piso|scala|citofono/gi, "").trim();
            const url =
              "https://api.openrouteservice.org/geocode/search?" +
              "api_key=" + encodeURIComponent(ORS_API_KEY) +
              "&text=" + encodeURIComponent(clean) +
              "&size=1";

            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              if (data.features && data.features.length) {
                item.lon = data.features[0].geometry.coordinates[0];
                item.lat = data.features[0].geometry.coordinates[1];
              }
            }
            await new Promise(r => setTimeout(r, 2000));
          } catch (e) {
            console.error(e);
          }
        }

        if (item.lat != null && item.lon != null) {
          item.dist = haversine(myLat, myLon, item.lat, item.lon);
        } else {
          item.dist = null;
        }
      }

      addresses.sort((a, b) => {
        if (a.dist == null && b.dist == null) return 0;
        if (a.dist == null) return 1;
        if (b.dist == null) return -1;
        return a.dist - b.dist;
      });

      saveData();
      alert("‚úÖ Ruta reordenada por distancia.");
    }, err => {
      alert("No se pudo obtener tu ubicaci√≥n.");
    });
  }

  // ==============================
  // RASTREO VIVO
  // ==============================

  function updateLiveBtn() {
    const btn = document.getElementById("liveBtn");
    if (!btn) return;
    if (liveTracking) {
      btn.textContent = "üõ∞ Rastreo vivo: ON";
      btn.classList.remove("btn-gray");
      btn.classList.add("btn-blue");
    } else {
      btn.textContent = "üõ∞ Rastreo vivo: OFF";
      btn.classList.remove("btn-blue");
      btn.classList.add("btn-gray");
    }
  }

  function toggleLiveTracking() {
    if (!liveTracking) {
      if (!navigator.geolocation) {
        alert("Tu dispositivo no permite obtener la ubicaci√≥n.");
        return;
      }

      liveWatchId = navigator.geolocation.watchPosition(
        handleLivePosition,
        () => {
          alert("Error en rastreo GPS.");
          stopLiveTracking();
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
      );

      liveTracking = true;
      updateLiveBtn();
      alert("üõ∞ Rastreo vivo ACTIVADO.");
    } else {
      stopLiveTracking();
      alert("üõ∞ Rastreo vivo detenido.");
    }
  }

  function stopLiveTracking() {
    if (liveWatchId != null) {
      navigator.geolocation.clearWatch(liveWatchId);
      liveWatchId = null;
    }
    liveTracking = false;
    updateLiveBtn();
  }

  function handleLivePosition(pos) {
    const myLat = pos.coords.latitude;
    const myLon = pos.coords.longitude;

    addresses.forEach(item => {
      if (item.lat != null && item.lon != null) {
        const d = haversine(myLat, myLon, item.lat, item.lon);
        item.dist = d;

        const meters = d * 1000;

        if (meters <= 100 && !item.nearAlerted) {
          item.nearAlerted = true;
          if (navigator.vibrate) navigator.vibrate(40);
        }

        if (meters <= 20 && !item.arrivedAlerted) {
          item.arrivedAlerted = true;
          if (navigator.vibrate) navigator.vibrate([60, 40, 60]);
        }
      }
    });

    if (autoSortEnabled) {
      addresses.sort((a, b) => {
        if (a.dist == null && b.dist == null) return 0;
        if (a.dist == null) return 1;
        if (b.dist == null) return -1;
        return a.dist - b.dist;
      });
    }

    saveData();
  }

  // ==============================
  // AUTO-ORGANIZAR
  // ==============================

  function updateAutoSortBtn() {
    const btn = document.getElementById("autoSortBtn");
    if (!btn) return;
    if (autoSortEnabled) {
      btn.textContent = "‚öôÔ∏è Auto-organizar: ON";
      btn.classList.remove("btn-gray");
      btn.classList.add("btn-blue");
    } else {
      btn.textContent = "‚öôÔ∏è Auto-organizar: OFF";
      btn.classList.remove("btn-blue");
      btn.classList.add("btn-gray");
    }
  }

  function toggleAutoSort() {
    autoSortEnabled = !autoSortEnabled;
    updateAutoSortBtn();
  }
</script>
</body>
</html>
