<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SomarDrive V16 üööüß†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0d1b3d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --card-bg: #1e293b;
      --accent: #3b82f6;
      --text: #f1f5f9;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --wa: #25D366;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text);
      padding-bottom: 140px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }

    /* HEADER */
    .god-banner {
      background: linear-gradient(135deg, #1e3a8a, #172554);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .god-title {
      font-weight: 800;
      color: #fbbf24;
      font-size: 1.1rem;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .god-text {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #e2e8f0;
      font-style: italic;
    }

    /* BOTONES PRINCIPALES */
    .btn-main {
      width: 100%;
      padding: 14px;
      margin-bottom: 10px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s, opacity 0.2s;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .btn-main:active {
      transform: scale(0.96);
    }

    .btn-blue {
      background: linear-gradient(to bottom, #3b82f6, #2563eb);
      box-shadow: 0 4px 0 #1d4ed8;
    }

    .btn-gray {
      background: linear-gradient(to bottom, #475569, #334155);
      box-shadow: 0 4px 0 #1e293b;
      color: #cbd5e1;
    }

    .btn-red {
      background: linear-gradient(to bottom, #ef4444, #dc2626);
      box-shadow: 0 4px 0 #b91c1c;
    }

    .btn-green {
      background: linear-gradient(to bottom, #22c55e, #16a34a);
      box-shadow: 0 4px 0 #15803d;
    }

    .btn-gold {
      background: linear-gradient(to bottom, #fbbf24, #d97706);
      box-shadow: 0 4px 0 #b45309;
      color: #000;
      text-shadow: none;
    }

    /* FOTO & OCR */
    #previewContainer {
      display: none;
      margin-top: 15px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #334155;
      position: relative;
    }

    #preview {
      width: 100%;
      display: block;
    }

    #ocrStatus {
      text-align: center;
      color: var(--accent);
      margin: 15px;
      font-weight: 600;
      display: none;
    }

    /* EDITOR */
    #editorSection {
      display: none;
      background: var(--card-bg);
      padding: 15px;
      border-radius: 15px;
      margin-top: 20px;
      border: 1px solid #334155;
    }

    #linesContainer {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 6px;
      background: #0f172a;
    }

    .line-item {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .line-item:last-child {
      border-bottom: none;
    }

    .address-input {
      width: 100%;
      background: #0f172a;
      border: 2px solid #334155;
      color: white;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      min-height: 80px;
      font-family: inherit;
      margin-top: 10px;
      resize: vertical;
    }

    .address-input:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* LISTA RUTA */
    #addressList {
      list-style: none;
      padding: 0;
      margin-top: 15px;
    }

    .card {
      background: var(--card-bg);
      margin-bottom: 12px;
      border-radius: 12px;
      padding: 15px;
      border-left: 5px solid var(--yellow);
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .card.done {
      border-left-color: var(--green);
      opacity: 0.75;
    }

    .card.issue {
      border-left-color: var(--red);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .card-text {
      font-size: 1.0rem;
      font-weight: 600;
      line-height: 1.3;
      color: white;
      word-break: break-word;
    }

    .card-meta {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #94a3b8;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* REORDENAR */
    .manual-sort {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sort-arrow {
      background: none;
      border: 1px solid #475569;
      color: #94a3b8;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 0.75rem;
    }

    /* ACCIONES CARD */
    .card-actions {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 8px;
    }

    .icon-btn {
      flex: 1;
      padding: 9px 0;
      border: none;
      border-radius: 8px;
      font-size: 1.3rem;
      cursor: pointer;
      background: rgba(255,255,255,0.06);
      color: #e5e7eb;
    }

    .icon-btn:active {
      transform: scale(0.97);
    }

    /* BACKUP / MEMORIA */
    .backup-area {
      margin-top: 30px;
      padding: 18px;
      background: #0f172a;
      border-radius: 15px;
      border: 2px dashed #334155;
      text-align: center;
    }

    .backup-label {
      color: #94a3b8;
      font-size: 0.9rem;
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* FOOTER FIJO */
    .footer-static {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to top, #020617 80%, transparent);
      z-index: 900;
      text-align: center;
      padding-bottom: 8px;
      pointer-events: none;
    }

    .safety-text {
      color: var(--red);
      font-weight: 800;
      font-size: 0.9rem;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* TOAST */
    #toast {
      visibility: hidden;
      min-width: 260px;
      max-width: 90%;
      background-color: #111827;
      color: #fff;
      text-align: center;
      border-radius: 50px;
      padding: 14px 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      font-weight: 600;
      font-size: 0.9rem;
    }

    #toast.show {
      visibility: visible;
      animation: fadein 0.25s, fadeout 0.25s 2.7s;
    }

    @keyframes fadein {
      from {bottom: 20px; opacity: 0;}
      to {bottom: 40px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 40px; opacity: 1;}
      to {bottom: 20px; opacity: 0;}
    }
  </style>
</head>
<body>

<div class="container">

  <div class="god-banner">
    <div class="god-title">üëë EL PRIMER LUGAR ES DE DIOS</div>
    <div class="god-text">"Encomienda a Jehov√° tu camino, y conf√≠a en √©l; y √©l har√°." (Salmos 37:5)</div>
  </div>

  <h2 style="color:#94a3b8; margin:20px 0 10px;">üì∏ 1. Capturar direcciones</h2>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <button class="btn-main btn-blue" onclick="document.getElementById('cameraInput').click()">üì∑ C√°mara</button>
    <button class="btn-main btn-gray" onclick="document.getElementById('fileInput').click()">üìÇ Galer√≠a</button>
  </div>
  <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="processImage(this)">
  <input type="file" id="fileInput" accept="image/*" hidden onchange="processImage(this)">

  <div id="previewContainer">
    <img id="preview" />
    <button class="btn-main btn-red" onclick="clearImage()" style="margin:10px; width:calc(100% - 20px);">‚ùå Cancelar foto</button>
  </div>
  <div id="ocrStatus">‚è≥ Leyendo texto (IT)...</div>

  <div id="editorSection">
    <h3 style="margin-top:0; color:#fbbf24;">üìù 2. Selecciona y forma la direcci√≥n</h3>
    <div id="linesContainer"></div>
    <textarea id="finalText" class="address-input" placeholder="Aqu√≠ aparecer√° la direcci√≥n combinada..."></textarea>
    <button class="btn-main btn-green" onclick="saveAddress()" style="margin-top:10px;">üíæ Guardar en Ruta</button>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px;">
    <h2 style="margin:0; display:flex; align-items:center; gap:8px;">
      üìç Ruta 
      <span style="background:#334155; padding:2px 8px; border-radius:10px; font-size:0.9rem;" id="countPending">0</span>
    </h2>
    <small style="color:#fbbf24; font-weight:bold;" id="historyBadge">Memoria: 0</small>
  </div>
  
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
    <button id="sortBtn" class="btn-main btn-gray" onclick="sortWithGPS()">üîÑ Ordenar por GPS</button>
    <button id="liveBtn" class="btn-main btn-gray" onclick="toggleLiveTracking()">üõ∞Ô∏è Rastreo vivo (futuro)</button>
  </div>

  <ul id="addressList"></ul>

  <div class="backup-area">
    <span class="backup-label">üõ°Ô∏è COPIAS Y LIMPIEZA</span>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
      <button class="btn-main btn-green" style="font-size:0.9rem;" onclick="exportData()">‚¨áÔ∏è Descargar Ruta</button>
      <button class="btn-main btn-gray" style="font-size:0.9rem;" onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Cargar Ruta</button>
    </div>
    <input type="file" id="importInput" accept=".json" hidden onchange="importData(this)">

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
      <button class="btn-main btn-red" style="font-size:0.85rem;" onclick="clearRoute()">üóëÔ∏è Borrar SOLO Ruta</button>
      <button class="btn-main btn-red" style="font-size:0.85rem;" onclick="clearMemory()">üí£ Borrar SOLO Memoria</button>
    </div>
  </div>

</div>

<div class="footer-static">
  <div class="safety-text">‚ö†Ô∏è CONDUCE CON CUIDADO ¬∑ EN CASA TE ESPERAN</div>
</div>

<div id="toast">Notificaci√≥n</div>

<script>
  // ==========================
  // CONFIGURACI√ìN GENERAL
  // ==========================

  // IMPORTANTE: pon aqu√≠ tu API KEY real de OpenRouteService
  // y RESTRINGE su uso por dominio en el panel de ORS.
  const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImI5NjlmYzJiMDY0YjQzMWQ5NDBmMGE0NjYzOWJiMWI2IiwiaCI6Im11cm11cjY0In0=";

  const DB_KEY   = "SomarDriveV16_Route";
  const HIST_KEY = "SomarDriveV16_Memory";

  let addresses = [];
  let historyDB = [];

  const toastEl = document.getElementById("toast");

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.className = "show";
    setTimeout(() => { toastEl.className = toastEl.className.replace("show", ""); }, 3000);
  }

  function saveData() {
    localStorage.setItem(DB_KEY, JSON.stringify(addresses));
    renderList();
  }

  function saveMem() {
    localStorage.setItem(HIST_KEY, JSON.stringify(historyDB));
    updateHistoryBadge();
  }

  function updateHistoryBadge() {
    document.getElementById("historyBadge").textContent = "Memoria: " + historyDB.length;
  }

  window.onload = () => {
    try {
      const r = localStorage.getItem(DB_KEY);
      if (r) addresses = JSON.parse(r);
    } catch(e){ addresses = []; }

    try {
      const m = localStorage.getItem(HIST_KEY);
      if (m) historyDB = JSON.parse(m);
    } catch(e){ historyDB = []; }

    renderList();
    updateHistoryBadge();
  };

  // ==========================
  // OCR (solo ITALIA)
  // ==========================

  const previewContainer = document.getElementById("previewContainer");
  const previewImg = document.getElementById("preview");
  const ocrStatus = document.getElementById("ocrStatus");
  const editorSection = document.getElementById("editorSection");
  const linesContainer = document.getElementById("linesContainer");
  const finalText = document.getElementById("finalText");

  function processImage(input) {
    if (!input.files[0]) return;
    const file = input.files[0];

    previewImg.src = URL.createObjectURL(file);
    previewContainer.style.display = "block";
    ocrStatus.style.display = "block";
    editorSection.style.display = "none";
    linesContainer.innerHTML = "";
    finalText.value = "";

    // Solo italiano para m√°xima precisi√≥n en direcciones IT
    Tesseract.recognize(file, 'ita').then(({ data: { text } }) => {
      ocrStatus.style.display = "none";
      showEditor(text);
    }).catch(e => {
      console.error(e);
      ocrStatus.style.display = "none";
      showToast("‚ùå Error al leer la imagen");
    });
  }

  function showEditor(text) {
    editorSection.style.display = "block";
    linesContainer.innerHTML = "";
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 3);

    if (lines.length === 0) {
      linesContainer.innerHTML = "<div style='color:#64748b; padding:6px;'>No se detect√≥ texto √∫til. Prueba otra foto.</div>";
      return;
    }

    lines.forEach(l => {
      const div = document.createElement("div");
      div.className = "line-item";
      div.innerHTML = `
        <input type="checkbox" onchange="updateInput()" value="${l.replace(/"/g,'&quot;')}">
        <span>${l}</span>
      `;
      linesContainer.appendChild(div);
    });

    finalText.value = "";
  }

  function updateInput() {
    const vals = Array.from(linesContainer.querySelectorAll("input[type='checkbox']:checked")).map(c => c.value);
    finalText.value = vals.join(", ");
  }

  function clearImage() {
    previewContainer.style.display = "none";
    editorSection.style.display = "none";
    document.getElementById("cameraInput").value = "";
    document.getElementById("fileInput").value = "";
    finalText.value = "";
  }

  // ==========================
  // MOTOR V16 ¬∑ COINCIDENCIAS
  // ==========================

  function normalizeText(str) {
    return str
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function similarityScore(a, b) {
    a = normalizeText(a);
    b = normalizeText(b);

    if (a === b) return 1;

    const wordsA = a.split(/[\s,.-]+/).filter(w => w.length > 2);
    if (wordsA.length === 0) return 0;

    let hits = 0;
    wordsA.forEach(w => {
      if (b.includes(w)) hits++;
    });

    return hits / wordsA.length;
  }

  function extractNumber(str) {
    const m = str.match(/\b\d+\b/);
    return m ? Number(m[0]) : null;
  }

  // Analiza la direcci√≥n contra la memoria (B3 ¬∑ 85%)
  function analyzeAddress(newText) {
    const newClean = normalizeText(newText);
    const newNum = extractNumber(newClean);

    let bestMatch = null;
    let bestScore = 0;

    for (const mem of historyDB) {
      const score = similarityScore(newClean, mem.text);
      if (score > bestScore) {
        bestScore = score;
        bestMatch = mem;
      }
    }

    // 1) Coincidencia EXACTA ‚Üí misma direcci√≥n, reusar
    if (bestScore === 1 && bestMatch) {
      return { type: "identical", mem: bestMatch, score: bestScore };
    }

    // 2) Misma calle (alta similitud) pero distinto n√∫mero ‚Üí casa nueva
    if (bestMatch) {
      const oldNum = extractNumber(bestMatch.text);
      if (oldNum !== null && newNum !== null && oldNum !== newNum) {
        // Si la similitud es alta, pero el n√∫mero cambia, lo tratamos como nueva direcci√≥n
        if (bestScore >= 0.6) {
          return {
            type: "same_street_new_number",
            mem: bestMatch,
            score: bestScore
          };
        }
      }
    }

    // 3) Coincidencia dudosa (posible error OCR) ‚Üí preguntar
    // Umbral B3: 0.50‚Äì0.85
    if (bestMatch && bestScore >= 0.50 && bestScore <= 0.85) {
      return {
        type: "possible_error",
        mem: bestMatch,
        score: bestScore
      };
    }

    // 4) Nueva direcci√≥n
    return { type: "new", mem: null, score: bestScore };
  }

  // ==========================
  // GUARDAR DIRECCI√ìN (V16)
  // ==========================

  function saveAddress() {
    const txt = finalText.value.trim();
    if (!txt) return showToast("‚ö†Ô∏è Escribe o selecciona la direcci√≥n");

    const analysis = analyzeAddress(txt);

    // 1) Id√©ntica a la memoria ‚Üí reusar
    if (analysis.type === "identical") {
      addresses.unshift({
        id: Date.now(),
        text: analysis.mem.text,
        status: 'pending',
        lat: analysis.mem.lat || null,
        lon: analysis.mem.lon || null,
        dist: null,
        fromMemory: true
      });
      saveData();
      clearImage();
      return showToast("üß† Direcci√≥n ya conocida ¬∑ usada de memoria");
    }

    // 2) Misma calle, n√∫mero distinto ‚Üí nueva direcci√≥n
    if (analysis.type === "same_street_new_number") {
      historyDB.push({ text: txt, lat: null, lon: null });
      saveMem();
      addresses.unshift({
        id: Date.now(),
        text: txt,
        status: 'pending',
        lat: null,
        lon: null,
        dist: null,
        fromMemory: false
      });
      saveData();
      clearImage();
      return showToast("üìç Nueva direcci√≥n en la misma calle");
    }

    // 3) Posible error OCR ‚Üí preguntar
    if (analysis.type === "possible_error") {
      const msg = 
`üß† Posible coincidencia encontrada:

En memoria:
"${analysis.mem.text}"

Nueva:
"${txt}"

¬øEs la misma direcci√≥n?`;

      const isSame = confirm(msg);

      if (isSame) {
        addresses.unshift({
          id: Date.now(),
          text: analysis.mem.text,
          status: 'pending',
          lat: analysis.mem.lat || null,
          lon: analysis.mem.lon || null,
          dist: null,
          fromMemory: true
        });
        saveData();
        clearImage();
        return showToast("‚úîÔ∏è Se us√≥ la direcci√≥n guardada en memoria");
      } else {
        historyDB.push({ text: txt, lat: null, lon: null });
        saveMem();
        addresses.unshift({
          id: Date.now(),
          text: txt,
          status: 'pending',
          lat: null,
          lon: null,
          dist: null,
          fromMemory: false
        });
        saveData();
        clearImage();
        return showToast("üìç Nueva direcci√≥n a√±adida");
      }
    }

    // 4) Totalmente nueva
    historyDB.push({ text: txt, lat: null, lon: null });
    saveMem();
    addresses.unshift({
      id: Date.now(),
      text: txt,
      status: 'pending',
      lat: null,
      lon: null,
      dist: null,
      fromMemory: false
    });
    saveData();
    clearImage();
    return showToast("üß† Nueva direcci√≥n aprendida");
  }

  // ==========================
  // LISTA ¬∑ RENDER
  // ==========================

  function renderList() {
    const list = document.getElementById("addressList");
    list.innerHTML = "";

    const pendingCount = addresses.filter(a => a.status === 'pending').length;
    document.getElementById("countPending").textContent = pendingCount;

    if (address