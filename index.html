<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SomarDrive üöö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#020617">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --card-bg: #0f172a;
      --panel-bg: #111827;
      --accent: #3b82f6;
      --accent-soft: #1d4ed8;
      --text: #f9fafb;
      --muted: #94a3b8;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --wa: #25D366;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text);
      padding-bottom: 140px;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 12px 14px 18px;
    }

    /* HEADER APP */
    .app-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }

   .app-logo {
  font-size: 3rem;   /* tama√±o del emoji */
  line-height: 1;
  display: flex;
  align-items: center;
}

.app-title-block {
  display: flex;
  flex-direction: column;
}

.app-title {
  font-size: 2rem;
  font-weight: 800;
}

.app-subtitle {
  font-size: 1rem;
  color: #94a3b8;
  margin-top: -4px;
}

    /* BANNER DIOS */
    .god-banner {
      background: linear-gradient(135deg, #1e3a8a, #172554);
      padding: 14px 14px 12px;
      border-radius: 18px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }

    .god-title {
      font-weight: 800;
      color: #facc15;
      font-size: 1rem;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .god-text {
      font-size: 0.86rem;
      line-height: 1.4;
      color: #e2e8f0;
      font-style: italic;
    }

    /* TITULOS SECCI√ìN */
    h2.section-title {
      margin: 16px 0 10px;
      font-size: 1.15rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* BOTONES PRINCIPALES */
    .btn-main {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 14px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      transition: transform 0.08s, box-shadow 0.12s;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
    }

    .btn-main:active {
      transform: scale(0.96);
      box-shadow: none;
    }

    .btn-blue {
      background: linear-gradient(to bottom, #3b82f6, #2563eb);
      box-shadow: 0 4px 0 #1d4ed8;
    }

    .btn-gray {
      background: linear-gradient(to bottom, #475569, #334155);
      box-shadow: 0 4px 0 #1f2937;
      color: #e5e7eb;
    }

    .btn-red {
      background: linear-gradient(to bottom, #ef4444, #dc2626);
      box-shadow: 0 4px 0 #b91c1c;
    }

    .btn-green {
      background: linear-gradient(to bottom, #22c55e, #16a34a);
      box-shadow: 0 4px 0 #15803d;
    }

    .btn-slim {
      padding: 10px;
      font-size: 0.9rem;
      border-radius: 12px;
    }

    .btn-pill {
      border-radius: 999px;
      padding-inline: 18px;
      font-size: 0.9rem;
    }

    /* FOTO & OCR */
    #previewContainer {
      display: none;
      margin-top: 12px;
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid #1f2937;
      position: relative;
      background: black;
    }

    #preview {
      width: 100%;
      display: block;
    }

    #ocrStatus {
      text-align: center;
      color: var(--accent);
      margin: 14px 4px 4px;
      font-weight: 600;
      display: none;
      font-size: 0.9rem;
    }

    /* EDITOR TEXTO DETECTADO */
    #editorSection {
      display: none;
      background: var(--panel-bg);
      padding: 14px;
      border-radius: 18px;
      margin-top: 16px;
      border: 1px solid #1f2937;
    }

    #linesContainer {
      max-height: 160px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 4px;
      background: #020617;
    }

    .line-item {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(148,163,184,0.18);
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .line-item:last-child {
      border-bottom: none;
    }

    .line-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .address-input {
      width: 100%;
      background: #020617;
      border: 2px solid #1f2937;
      color: white;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 0.95rem;
      min-height: 80px;
      font-family: inherit;
      margin-top: 10px;
      resize: vertical;
    }

    .address-input:focus {
      border-color: var(--accent);
      outline: none;
    }

    /* RUTA + MEMORIA */
    .route-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 22px;
      margin-bottom: 8px;
    }

    .route-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.2rem;
      font-weight: 800;
    }

    .route-count {
      background: #111827;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.95rem;
    }

    .mem-btn {
      border: none;
      background: #facc15;
      color: #111827;
      font-weight: 800;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 3px 0 #ca8a04;
    }

    .mem-btn:active {
      transform: scale(0.96);
      box-shadow: none;
    }

    /* LISTA RUTA */
    #addressList {
      list-style: none;
      padding: 0;
      margin: 14px 0 0;
    }

    .card {
      background: var(--card-bg);
      margin-bottom: 10px;
      border-radius: 18px;
      padding: 12px 12px 14px;
      border-left: 5px solid var(--yellow);
      position: relative;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    }

    .card.done {
      border-left-color: var(--green);
      opacity: 0.85;
    }

    .card.issue {
      border-left-color: var(--red);
    }

    .card-text {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.35;
      color: #f9fafb;
      word-break: break-word;
    }

    .card-meta {
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      align-items: center;
    }

    .btn-nav {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: linear-gradient(to bottom, #3b82f6, #2563eb);
      color: #f9fafb;
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      box-shadow: 0 3px 0 #1d4ed8;
    }

    .btn-nav:active {
      transform: scale(0.96);
      box-shadow: none;
    }

    .btn-trash {
      width: 56px;
      height: 44px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(to bottom, #f97373, #ef4444);
      box-shadow: 0 3px 0 #b91c1c;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .btn-trash:active {
      transform: scale(0.94);
      box-shadow: none;
    }

    /* BACKUP / MEMORIA */
    .backup-area {
      margin-top: 26px;
      padding: 16px 14px 18px;
      background: #020617;
      border-radius: 18px;
      border: 2px dashed #1e293b;
    }

    .backup-label {
      color: #e5e7eb;
      font-size: 0.85rem;
      display: block;
      margin-bottom: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .backup-image img {
      width: 100%;
      max-width: 360px;
      display: block;
      margin: 18px auto 0;
      border-radius: 18px;
    }

    /* FOOTER FIJO */
    .footer-static {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(to top, #020617 80%, transparent);
      z-index: 900;
      text-align: center;
      padding-bottom: 6px;
      pointer-events: none;
    }

    .safety-text {
      color: var(--red);
      font-weight: 800;
      font-size: 0.9rem;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* TOAST */
    #toast {
      visibility: hidden;
      min-width: 260px;
      max-width: 90%;
      background-color: #020617;
      color: #fff;
      text-align: center;
      border-radius: 999px;
      padding: 12px 16px;
      position: fixed;
      z-index: 1200;
      left: 50%;
      bottom: 38px;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      font-weight: 600;
      font-size: 0.9rem;
    }

    #toast.show {
      visibility: visible;
      animation: fadein 0.2s, fadeout 0.3s 2.6s;
    }

    @keyframes fadein {
      from {bottom: 20px; opacity: 0;}
      to {bottom: 38px; opacity: 1;}
    }

    @keyframes fadeout {
      from {bottom: 38px; opacity: 1;}
      to {bottom: 20px; opacity: 0;}
    }

    /* MODAL MEMORIA */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-panel {
      background: #020617;
      border-radius: 22px;
      padding: 14px 14px 16px;
      width: calc(100% - 24px);
      max-width: 640px;
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.9);
      border: 1px solid #1e293b;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-close-modal {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #e5e7eb;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .modal-search {
      margin-bottom: 8px;
    }

    .modal-search input {
      width: 100%;
      border-radius: 999px;
      border: 2px solid #1f2937;
      background: #020617;
      padding: 8px 14px;
      color: #e5e7eb;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .modal-search input:focus {
      border-color: var(--accent);
      outline: none;
    }

    .memory-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 10px;
    }

    .memory-item {
      background: #020617;
      border-radius: 14px;
      padding: 8px 8px 10px;
      border: 1px solid #1e293b;
      margin-bottom: 8px;
    }

    .memory-text {
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .memory-actions {
      display: flex;
      gap: 6px;
    }

    .btn-mini {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 8px;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .btn-mini-green {
      background: linear-gradient(to bottom, #22c55e, #16a34a);
      color: #f9fafb;
    }

    .btn-mini-blue {
      background: linear-gradient(to bottom, #3b82f6, #2563eb);
      color: #f9fafb;
    }

    .btn-mini-red {
      background: linear-gradient(to bottom, #f97373, #ef4444);
      color: #f9fafb;
    }

    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 2px;
    }

    .btn-footer {
      flex: 1;
      border-radius: 14px;
      border: none;
      padding: 10px 8px;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-footer-gray {
      background: #111827;
      color: #e5e7eb;
    }

    .btn-footer-red {
      background: linear-gradient(to bottom, #f97373, #ef4444);
      color: #f9fafb;
    }

    /* BOTONES NAVEGACI√ìN SUPERIOR */
    .nav-block {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .status-chip {
      font-size: 0.9rem;
    }

    /* small screens adjustments */
    @media (min-width: 480px) {
      .nav-block {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- HEADER APP -->
    <div class="app-header">
      <div class="app-logo">üöö</div>

      <div class="app-title-block">
        <div class="app-title">SOMARDRIVE</div>
        <div class="app-subtitle">Jes√∫s va conmigo en cada ruta</div>
      </div>
    </div>

    <!-- BANNER DIOS -->
    <div class="god-banner">
      <div class="god-title">üëë EL PRIMER LUGAR ES DE DIOS</div>
      <div class="god-text">
        "Encomienda a Jehov√° tu camino, y conf√≠a en √©l; y √©l har√°." (Salmos 37:5)
      </div>
    </div>

    <!-- CAPTURAR -->
    <h2 class="section-title">üì∏ 1. Capturar direcci√≥n</h2>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <button class="btn-main btn-blue" onclick="document.getElementById('cameraInput').click()">üì∑ C√°mara</button>
      <button class="btn-main btn-gray" onclick="document.getElementById('fileInput').click()">üìÇ Galer√≠a</button>
    </div>
    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden onchange="processImage(this)">
    <input type="file" id="fileInput" accept="image/*" hidden onchange="processImage(this)">

    <div id="previewContainer">
      <img id="preview" alt="Previsualizaci√≥n" />
      <button class="btn-main btn-red btn-slim" onclick="clearImage()" style="margin:10px;">‚ùå Cancelar foto</button>
    </div>
    <div id="ocrStatus">‚è≥ Leyendo texto (IT)...</div>

    <!-- EDITOR -->
    <div id="editorSection">
      <h3 style="margin:0 0 6px; color:#facc15; font-size:1rem;">üìù 2. Selecciona y arma la direcci√≥n</h3>
      <div id="linesContainer"></div>
      <textarea id="finalText" class="address-input" placeholder="Aqu√≠ aparecer√° la direcci√≥n combinada..."></textarea>
      <button class="btn-main btn-green btn-slim" onclick="saveAddress()" style="margin-top:10px;">üíæ Guardar en Ruta</button>
    </div>

    <!-- RUTA + MEMORIA -->
    <div class="route-header">
      <div class="route-title">
        üìç Ruta <span class="route-count" id="routeCount">0</span>
      </div>
      <button class="mem-btn" onclick="openMemoryModal()">
        üß† <span id="memBadge">Memoria: 0</span>
      </button>
    </div>

    <!-- NAVIGATION BUTTONS -->
    <div class="nav-block">
      <button id="sortBtn" class="btn-main btn-gray btn-slim" onclick="sortWithGPS()">üîÑ Ordenar por GPS</button>
      <button id="liveBtn" class="btn-main btn-gray btn-slim" onclick="toggleLiveTracking()">
        üõ∞Ô∏è <span id="liveLabel">Rastreo vivo: OFF</span>
      </button>
      <button id="autoBtn" class="btn-main btn-gray btn-slim" onclick="toggleAutoOrganize()">
        ‚öôÔ∏è <span id="autoLabel">Auto-organizar: OFF</span>
      </button>
    </div>

    <!-- LISTA RUTA -->
    <ul id="addressList"></ul>

    <!-- COPIAS Y LIMPIEZA -->
    <div class="backup-area">
      <span class="backup-label">üõ°Ô∏è COPIAS Y LIMPIEZA</span>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <button class="btn-main btn-green btn-slim" onclick="exportData()">‚¨áÔ∏è Descargar Ruta</button>
        <button class="btn-main btn-gray btn-slim" onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Cargar Ruta</button>
      </div>
      <input type="file" id="importInput" accept=".json" hidden onchange="importData(this)">

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
        <button class="btn-main btn-red btn-slim" onclick="clearRoute()">üóëÔ∏è Borrar SOLO Ruta</button>
        <button class="btn-main btn-red btn-slim" onclick="clearMemory()">üí£ Borrar SOLO Memoria</button>
      </div>

      <!-- Guardar ruta completa en memoria -->
      <button class="btn-main btn-blue btn-slim" onclick="saveRouteToMemory()">
        üß†üíæ Guardar ruta en memoria
      </button>

      <!-- Imagen SomarDrive -->
      <div class="backup-image">
        <img src="camion-somardrive.png" alt="SomarDrive en tr√°nsito">
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer-static">
    <div class="safety-text">‚ö†Ô∏è CONDUCE CON CUIDADO ¬∑ EN CASA TE ESPERAN</div>
  </div>

  <!-- TOAST -->
  <div id="toast">Notificaci√≥n</div>

  <!-- MODAL MEMORIA -->
  <div id="memoryModal" class="modal-backdrop">
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title">üß† Memoria de direcciones</div>
        <button class="btn-close-modal" onclick="closeMemoryModal()">‚úï</button>
      </div>

      <div class="modal-search">
        <input id="memorySearch" type="text" placeholder="Buscar por nombre, calle, ciudad..." oninput="renderMemoryList()" />
      </div>

      <div id="memoryList" class="memory-list"></div>

      <div class="modal-footer">
        <button class="btn-footer btn-footer-gray" onclick="cleanDuplicates()">üßπ Limpiar duplicados</button>
        <button class="btn-footer btn-footer-red" onclick="clearMemoryAll()">üí£ Borrar TODO</button>
      </div>
    </div>
  </div>

<script>
  // ==========================
  // CONFIG GENERAL
  // ==========================

  // Cambia esto por tu API real de OpenRouteService
  // Ejemplo: const ORS_API_KEY = "5af3d3c9xxxxxxxxxxxxxxxxxxxxxxx";
  const ORS_API_KEY = "PON_AQUI_TU_API_KEY_DE_ORS";

  const DB_KEY   = "SomarDrive_Route_V20";
  const HIST_KEY = "SomarDrive_Memory_V20";

  const toastEl = document.getElementById("toast");

  let addresses = []; // { id, text, status, lat, lon, dist, fromMemory }
  let memoryDB  = []; // { id, text, lat, lon }

  let liveTracking = false;
  let autoOrganize = false;
  let liveInterval = null;

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.className = "show";
    setTimeout(() => {
      toastEl.className = toastEl.className.replace("show", "");
    }, 2900);
  }

  function saveRoute() {
    localStorage.setItem(DB_KEY, JSON.stringify(addresses));
    renderList();
  }

  function saveMemory() {
    localStorage.setItem(HIST_KEY, JSON.stringify(memoryDB));
    updateMemBadge();
  }

  function updateMemBadge() {
    document.getElementById("memBadge").textContent = "Memoria: " + memoryDB.length;
  }

  function updateRouteCount() {
    document.getElementById("routeCount").textContent = addresses.length;
  }

  window.addEventListener("load", () => {
    try {
      const r = localStorage.getItem(DB_KEY);
      if (r) addresses = JSON.parse(r);
    } catch (e) {
      addresses = [];
    }

    try {
      const m = localStorage.getItem(HIST_KEY);
      if (m) memoryDB = JSON.parse(m);
    } catch (e) {
      memoryDB = [];
    }

    renderList();
    updateMemBadge();
  });

  // ==========================
  // OCR ITALIANO
  // ==========================

  const previewContainer = document.getElementById("previewContainer");
  const previewImg       = document.getElementById("preview");
  const ocrStatus        = document.getElementById("ocrStatus");
  const editorSection    = document.getElementById("editorSection");
  const linesContainer   = document.getElementById("linesContainer");
  const finalText        = document.getElementById("finalText");

  function processImage(input) {
    if (!input.files[0]) return;
    const file = input.files[0];

    previewImg.src = URL.createObjectURL(file);
    previewContainer.style.display = "block";
    ocrStatus.style.display = "block";
    editorSection.style.display = "none";
    linesContainer.innerHTML = "";
    finalText.value = "";

    Tesseract.recognize(file, 'ita')
      .then(({ data: { text } }) => {
        ocrStatus.style.display = "none";
        showEditor(text);
      })
      .catch(e => {
        console.error(e);
        ocrStatus.style.display = "none";
        showToast("‚ùå Error al leer la imagen");
      });
  }

  function showEditor(text) {
    editorSection.style.display = "block";
    linesContainer.innerHTML = "";
    const lines = text
      .split('\n')
      .map(l => l.trim())
      .filter(l => l.length > 3);

    if (!lines.length) {
      linesContainer.innerHTML =
        "<div style='color:#64748b; padding:6px;'>No se detect√≥ texto √∫til. Prueba otra foto.</div>";
      return;
    }

    lines.forEach(l => {
      const div = document.createElement("div");
      div.className = "line-item";
      const safeVal = l.replace(/"/g, '&quot;');
      div.innerHTML = `
        <input type="checkbox" onchange="updateInput()" value="${safeVal}">
        <span>${l}</span>
      `;
      linesContainer.appendChild(div);
    });

    finalText.value = "";
  }

  function updateInput() {
    const vals = Array.from(
      linesContainer.querySelectorAll("input[type='checkbox']:checked")
    ).map(c => c.value);
    finalText.value = vals.join(", ");
  }

  function clearImage() {
    previewContainer.style.display = "none";
    editorSection.style.display = "none";
    document.getElementById("cameraInput").value = "";
    document.getElementById("fileInput").value = "";
    finalText.value = "";
  }

  // ==========================
  // UTILIDADES TEXTO
  // ==========================

  function normalizeText(str) {
    return (str || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function similarityScore(a, b) {
    a = normalizeText(a);
    b = normalizeText(b);

    if (!a || !b) return 0;
    if (a === b) return 1;

    const wordsA = a.split(/[\s,.-]+/).filter(w => w.length > 2);
    if (!wordsA.length) return 0;

    let hits = 0;
    wordsA.forEach(w => {
      if (b.includes(w)) hits++;
    });

    return hits / wordsA.length;
  }

  function extractNumber(str) {
    const m = (str || "").match(/\b\d+\b/);
    return m ? Number(m[0]) : null;
  }

  function findMemoryByText(text) {
    const clean = normalizeText(text);
    return memoryDB.find(m => normalizeText(m.text) === clean) || null;
  }

  function addToMemory(text, lat = null, lon = null) {
    const existing = findMemoryByText(text);
    if (existing) {
      // Actualizamos coords si vienen mejores
      if (lat != null && lon != null) {
        existing.lat = lat;
        existing.lon = lon;
        saveMemory();
      }
      return false;
    }
    memoryDB.push({
      id: Date.now() + Math.random(),
      text: text.trim(),
      lat,
      lon
    });
    saveMemory();
    return true;
  }

  // Analiza contra memoria
  function analyzeAddress(newText) {
    const newClean = normalizeText(newText);
    const newNum   = extractNumber(newClean);

    let bestMatch = null;
    let bestScore = 0;

    for (const mem of memoryDB) {
      const score = similarityScore(newClean, mem.text);
      if (score > bestScore) {
        bestScore = score;
        bestMatch = mem;
      }
    }

    if (bestScore === 1 && bestMatch) {
      return { type: "identical", mem: bestMatch, score: bestScore };
    }

    if (bestMatch) {
      const oldNum = extractNumber(bestMatch.text);
      if (oldNum !== null && newNum !== null && oldNum !== newNum) {
        if (bestScore >= 0.6) {
          return {
            type: "same_street_new_number",
            mem: bestMatch,
            score: bestScore
          };
        }
      }
    }

    if (bestMatch && bestScore >= 0.5 && bestScore <= 0.85) {
      return {
        type: "possible_error",
        mem: bestMatch,
        score: bestScore
      };
    }

    return { type: "new", mem: null, score: bestScore };
  }

  // ==========================
  // GUARDAR DIRECCI√ìN
  // ==========================

  function saveAddress() {
    const txt = finalText.value.trim();
    if (!txt) {
      showToast("‚ö†Ô∏è Escribe o selecciona la direcci√≥n");
      return;
    }

    const analysis = analyzeAddress(txt);

    if (analysis.type === "identical") {
      addresses.unshift({
        id: Date.now(),
        text: analysis.mem.text,
        status: "pending",
        lat: analysis.mem.lat ?? null,
        lon: analysis.mem.lon ?? null,
        dist: null,
        fromMemory: true
      });
      saveRoute();
      clearImage();
      showToast("üß† Direcci√≥n ya conocida ¬∑ usada de memoria");
      return;
    }

    if (analysis.type === "same_street_new_number") {
      addToMemory(txt);
      addresses.unshift({
        id: Date.now(),
        text: txt,
        status: "pending",
        lat: null,
        lon: null,
        dist: null,
        fromMemory: false
      });
      saveRoute();
      clearImage();
      showToast("üìç Nueva direcci√≥n en la misma calle");
      return;
    }

    if (analysis.type === "possible_error") {
      const msg =
`üß† Posible coincidencia encontrada:

En memoria:
"${analysis.mem.text}"

Nueva:
"${txt}"

¬øEs la misma direcci√≥n?`;
      const isSame = confirm(msg);

      if (isSame) {
        addresses.unshift({
          id: Date.now(),
          text: analysis.mem.text,
          status: "pending",
          lat: analysis.mem.lat ?? null,
          lon: analysis.mem.lon ?? null,
          dist: null,
          fromMemory: true
        });
        saveRoute();
        clearImage();
        showToast("‚úîÔ∏è Se us√≥ la direcci√≥n guardada en memoria");
        return;
      } else {
        addToMemory(txt);
        addresses.unshift({
          id: Date.now(),
          text: txt,
          status: "pending",
          lat: null,
          lon: null,
          dist: null,
          fromMemory: false
        });
        saveRoute();
        clearImage();
        showToast("üìç Nueva direcci√≥n a√±adida");
        return;
      }
    }

    // Nueva totalmente
    addToMemory(txt);
    addresses.unshift({
      id: Date.now(),
      text: txt,
      status: "pending",
      lat: null,
      lon: null,
      dist: null,
      fromMemory: false
    });
    saveRoute();
    clearImage();
    showToast("üß† Nueva direcci√≥n aprendida");
  }

  // ==========================
  // LISTA RUTA
  // ==========================

  function renderList() {
    const list = document.getElementById("addressList");
    list.innerHTML = "";

    updateRouteCount();

    if (!addresses.length) {
      list.innerHTML =
        "<div style='text-align:center;padding:20px;color:#64748b;'>Sin direcciones.<br>Empieza capturando una foto.</div>";
      return;
    }

    addresses.forEach((item, index) => {
      const li = document.createElement("li");
      li.className = "card " + (item.status || "pending");

      const distTag = item.dist != null
        ? `<span style="color:var(--accent);font-weight:700;">üèÅ ${item.dist.toFixed(1)} km</span>`
        : "";

      const memTag = item.fromMemory
        ? `<span style="color:#d946ef;font-weight:700;">üß† Memoria</span>`
        : "";

      li.innerHTML = `
        <div class="card-text">${item.text}</div>
        <div class="card-meta">
          ${distTag}
          ${memTag}
        </div>
        <div class="card-actions">
          <button class="btn-nav" onclick="openMap(${index})">
            üó∫Ô∏è Navegar
          </button>
          <button class="btn-trash" onclick="deleteItem(${index})">üóëÔ∏è</button>
        </div>
      `;
      list.appendChild(li);
    });
  }

  function openMap(index) {
    const item = addresses[index];
    if (item.lat != null && item.lon != null) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lon}`;
      window.open(url, "_blank");
    } else {
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.text)}`;
      window.open(url, "_blank");
    }
  }

  function deleteItem(index) {
    if (!confirm("¬øBorrar esta direcci√≥n de la ruta?\nLa memoria se mantiene.")) return;
    addresses.splice(index, 1);
    saveRoute();
    showToast("üóëÔ∏è Direcci√≥n borrada de la ruta");
  }

  // ==========================
  // GPS & RASTREO
  // ==========================

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = deg => (deg * Math.PI) / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  async function sortWithGPS(fromLive = false) {
    if (!addresses.length) {
      if (!fromLive) showToast("No hay direcciones para ordenar.");
      return;
    }

    if (!navigator.geolocation) {
      showToast("Tu dispositivo no permite obtener la ubicaci√≥n.");
      return;
    }

    if (!ORS_API_KEY || ORS_API_KEY === "PON_AQUI_TU_API_KEY_DE_ORS") {
      showToast("Configura tu API KEY de OpenRouteService en el c√≥digo.");
      return;
    }

    if (!fromLive) showToast("üì° Calculando ruta por GPS...");

    navigator.geolocation.getCurrentPosition(async pos => {
      const myLat = pos.coords.latitude;
      const myLon = pos.coords.longitude;

      for (const item of addresses) {
        if (item.lat == null || item.lon == null) {
          try {
            const clean = (item.text || "")
              .replace(/cliente|entregar|consegna|tel|cel|cell|citofono|piso|piano|scala/gi, "")
              .trim();

            const url =
              "https://api.openrouteservice.org/geocode/search?" +
              "api_key=" + encodeURIComponent(ORS_API_KEY) +
              "&text=" + encodeURIComponent(clean) +
              "&size=1";

            const res = await fetch(url);
            if (!res.ok) throw new Error("Error ORS");
            const data = await res.json();
            if (data.features && data.features.length) {
              item.lon = data.features[0].geometry.coordinates[0];
              item.lat = data.features[0].geometry.coordinates[1];
            }
            await new Promise(r => setTimeout(r, 600));
          } catch (e) {
            console.error(e);
          }
        }

        if (item.lat != null && item.lon != null) {
          item.dist = haversine(myLat, myLon, item.lat, item.lon);
        } else {
          item.dist = null;
        }
      }

      addresses.sort((a, b) => {
        if (a.dist == null && b.dist == null) return 0;
        if (a.dist == null) return 1;
        if (b.dist == null) return -1;
        return a.dist - b.dist;
      });

      saveRoute();
      if (!fromLive) showToast("‚úÖ Ruta reordenada por distancia");
    }, err => {
      console.error(err);
      showToast("No se pudo obtener tu ubicaci√≥n");
    });
  }

  function toggleLiveTracking() {
    liveTracking = !liveTracking;
    const label = document.getElementById("liveLabel");
    label.textContent = "Rastreo vivo: " + (liveTracking ? "ON" : "OFF");

    if (liveTracking) {
      if (liveInterval) clearInterval(liveInterval);
      liveInterval = setInterval(() => sortWithGPS(true), 10000); // cada 10s
      showToast("üõ∞Ô∏è Rastreo vivo activado");
    } else {
      if (liveInterval) clearInterval(liveInterval);
      liveInterval = null;
      showToast("üõ∞Ô∏è Rastreo vivo desactivado");
    }
  }

  function toggleAutoOrganize() {
    autoOrganize = !autoOrganize;
    const label = document.getElementById("autoLabel");
    label.textContent = "Auto-organizar: " + (autoOrganize ? "ON" : "OFF");

    if (autoOrganize && addresses.length) {
      sortWithGPS(true);
      showToast("‚öôÔ∏è Auto-organizar activado");
    } else if (!autoOrganize) {
      showToast("‚öôÔ∏è Auto-organizar desactivado");
    }
  }

  // ==========================
  // BACKUP
  // ==========================

  function exportData() {
    if (!addresses.length) {
      showToast("No hay ruta para exportar.");
      return;
    }
    const dataStr =
      "data:text/json;charset=utf-8," +
      encodeURIComponent(JSON.stringify(addresses));
    const a = document.createElement("a");
    a.href = dataStr;
    a.download = "somardrive_ruta.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        if (Array.isArray(imported)) {
          addresses = imported;
          saveRoute();
          showToast("‚úÖ Ruta cargada desde archivo");
        } else {
          showToast("Formato de archivo incorrecto");
        }
      } catch (err) {
        console.error(err);
        showToast("Error al leer el archivo");
      }
      input.value = "";
    };
    reader.readAsText(file);
  }

  function clearRoute() {
    if (!addresses.length) {
      showToast("No hay ruta para borrar.");
      return;
    }
    if (!confirm("¬øBorrar SOLO la ruta?\nLa memoria se mantiene.")) return;
    addresses = [];
    saveRoute();
    showToast("üóëÔ∏è Ruta borrada");
  }

  function clearMemory() {
    if (!memoryDB.length) {
      showToast("No hay memoria para borrar.");
      return;
    }
    if (!confirm("‚ö†Ô∏è ¬øBorrar TODA la memoria guardada?\nLa ruta actual se mantiene.")) return;
    memoryDB = [];
    saveMemory();
    showToast("üí£ Memoria borrada");
  }

  function saveRouteToMemory() {
    if (!addresses.length) {
      showToast("No hay ruta para guardar en memoria.");
      return;
    }
    let added = 0;
    for (const item of addresses) {
      if (addToMemory(item.text, item.lat ?? null, item.lon ?? null)) {
        added++;
      }
    }
    if (added === 0) {
      showToast("üß† Todas las direcciones ya estaban en memoria");
    } else {
      showToast(`üß† ${added} direcciones guardadas en memoria`);
    }
  }

  // ==========================
  // MODAL MEMORIA
  // ==========================

  const memoryModal = document.getElementById("memoryModal");
  const memoryList  = document.getElementById("memoryList");
  const memorySearch = document.getElementById("memorySearch");

  function openMemoryModal() {
    memoryModal.classList.add("show");
    renderMemoryList();
  }

  function closeMemoryModal() {
    memoryModal.classList.remove("show");
  }

  function renderMemoryList() {
    memoryList.innerHTML = "";
    if (!memoryDB.length) {
      memoryList.innerHTML =
        "<div style='color:#64748b; padding:10px; text-align:center;'>No hay direcciones en memoria.</div>";
      return;
    }

    const q = normalizeText(memorySearch.value || "");
    const filtered = q
  ? memoryDB.filter(m => normalizeText(m.text).includes(q))
  : memoryDB.slice();

// üî† Ordenar de A a Z
filtered.sort((a, b) => {
  const textA = normalizeText(a.text);
  const textB = normalizeText(b.text);
  return textA.localeCompare(textB);
});

    if (!filtered.length) {
      memoryList.innerHTML =
        "<div style='color:#64748b; padding:10px; text-align:center;'>No se encontraron coincidencias.</div>";
      return;
    }

    filtered.forEach(mem => {
      const div = document.createElement("div");
      div.className = "memory-item";
      div.innerHTML = `
        <div class="memory-text">${mem.text}</div>
        <div class="memory-actions">
          <button class="btn-mini btn-mini-green" onclick="useFromMemory(${mem.id})">‚ûï Usar</button>
          <button class="btn-mini btn-mini-blue" onclick="editMemory(${mem.id})">‚úèÔ∏è Editar</button>
          <button class="btn-mini btn-mini-red" onclick="deleteMemory(${mem.id})">üóëÔ∏è Borrar</button>
        </div>
      `;
      memoryList.appendChild(div);
    });
  }

  function useFromMemory(id) {
    const mem = memoryDB.find(m => m.id === id);
    if (!mem) return;
    addresses.unshift({
      id: Date.now(),
      text: mem.text,
      status: "pending",
      lat: mem.lat ?? null,
      lon: mem.lon ?? null,
      dist: null,
      fromMemory: true
    });
    saveRoute();
    showToast("üìç Direcci√≥n a√±adida desde memoria");
  }

  function editMemory(id) {
    const mem = memoryDB.find(m => m.id === id);
    if (!mem) return;
    const updated = prompt("Editar direcci√≥n de memoria:", mem.text);
    if (!updated) return;
    mem.text = updated.trim();
    saveMemory();
    renderMemoryList();
    showToast("‚úèÔ∏è Direcci√≥n actualizada en memoria");
  }

  function deleteMemory(id) {
    if (!confirm("¬øBorrar esta direcci√≥n de la memoria?")) return;
    memoryDB = memoryDB.filter(m => m.id !== id);
    saveMemory();
    renderMemoryList();
    showToast("üóëÔ∏è Direcci√≥n borrada de memoria");
  }

  function cleanDuplicates() {
    if (!memoryDB.length) return;
    const map = new Map();
    const cleaned = [];
    for (const m of memoryDB) {
      const key = normalizeText(m.text);
      if (!map.has(key)) {
        map.set(key, true);
        cleaned.push(m);
      }
    }
    const removed = memoryDB.length - cleaned.length;
    memoryDB = cleaned;
    saveMemory();
    renderMemoryList();
    if (removed > 0) {
      showToast(`üßπ ${removed} duplicados eliminados`);
    } else {
      showToast("üßπ No se encontraron duplicados");
    }
  }

  function clearMemoryAll() {
    if (!memoryDB.length) {
      showToast("No hay memoria para borrar.");
      return;
    }
    if (!confirm("‚ö†Ô∏è Esto borrar√° TODAS las direcciones guardadas en memoria.\n¬øContinuar?")) return;
    memoryDB = [];
    saveMemory();
    renderMemoryList();
    showToast("üí£ Memoria borrada por completo");
  }
</script>
</body>
</html>
